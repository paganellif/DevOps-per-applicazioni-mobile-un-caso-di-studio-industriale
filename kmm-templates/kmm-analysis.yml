#########################################
# DEPENDENCY CHECK
#########################################
.dependency-check:
  stage: analysis
  image:
    name: owasp/dependency-check:7.1.1
    entrypoint: [""]
  dependencies: []
  allow_failure: true
  variables:
    REPORT_FORMAT: XML
    PROJECT_DIR: to_be_extended
    REPORT_PATH: ${CI_PROJECT_DIR}/reports
  script:
    - /usr/share/dependency-check/bin/dependency-check.sh --format="${REPORT_FORMAT}" --scan="${PROJECT_DIR}" -o="${REPORT_PATH}"
  artifacts:
    name: dependency-check-report
    expire_in: 1 day
    paths:
      - "reports/dependency-check-report.*"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

#########################################
# STATIC ANALYSIS
#########################################
.static-analysis:android:
  stage: analysis
  allow_failure: true
  extends: .base-android
  variables:
    PROJECT_DIR: to_be_extended
  script:
    - cd $PROJECT_DIR
    - bundle install
    - export FL_GRADLE_TASK="lint"
    - bundle exec fastlane run gradle
    - export FL_GRADLE_TASK="detekt"
    - bundle exec fastlane run gradle
  artifacts:
    name: static-analysis-report-android
    expire_in: 1 day
    when: always
    paths:
      - ${PROJECT_DIR}/build/reports/lint-results-debug.*
      - ${PROJECT_DIR}/build/reports/detekt/*
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

.static-analysis:ios:
  stage: analysis
  image: ghcr.io/realm/swiftlint:5.5-latest
  dependencies: []
  allow_failure: true
  variables:
    PODS_DIR: ${CI_PROJECT_DIR}/${PROJECT_DIR}/Pods
    LINT_PATH: ${CI_PROJECT_DIR}/${PROJECT_DIR}
    REPORT_PATH: ${CI_PROJECT_DIR}/reports/swiftlint.json
  script:
    - swiftlint $LINT_PATH --reporter="sonarqube" > $REPORT_PATH
  artifacts:
    name: static-analysis-report-ios
    when: always
    expire_in: 1 day
    paths:
      - reports/swiftlint.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

#########################################
# SONARQUBE
#########################################
.sonar-qube:
  stage: analysis
  image: sonarsource/sonar-scanner-cli:4.7.0
  allow_failure: true
  variables:
    PROJECT_DIR: to_be_extended
    SONAR_USER_HOME: ${CI_PROJECT_DIR}/${PROJECT_DIR}/.sonar
    SONAR_PROJECT_KEY: to_be_extended
    GIT_DEPTH: "0"
  script:
    - cd $PROJECT_DIR
    - sonar-scanner -Dsonar.login=$CI_SONAR_LOGIN -Dsonar.host.url=$CI_SONAR_HOST -Dsonar.projectKey=$SONAR_PROJECT_KEY
  cache:
    key: "${CI_JOB_NAME}-sonar-cache"
    paths:
      - ${CI_PROJECT_DIR}/${PROJECT_DIR}/.sonar/cache
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
